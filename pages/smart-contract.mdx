# Develope, test and deploy a smart contract

## Development

### Preparation

- Install dotnet sdk.
  - Follow this doc https://dotnet.microsoft.com/en-us/download to install dotnet sdk. You can choose the 6.x or 7.x version.
  - Type ```dotnet --version```, if return the version of dotnet sdk, the installation is successful.

- Install node.
  - Follow this doc https://nodejs.org/en/download to install node and npm.
  - Type ```node -v``` and ```npm -v```, if return the versions, the installation is successful.


### Create new project

- Open a terminal and type the following command. You can install the contract template from nuget repo to your local.

```
 $ PROD: dotnet new install AElf.HelloWorld.Contract
 $ DEV: dotnet new install AElf.HelloWorld.Contract --nuget-source http://10.0.1.239:8081/repository/nuget-group/index.json
```
After installing, you can use dotnet new uninstall to check this template on local.

- Type the following command, and create a new template project locally. You can modify custom parameters of command to define contract names and namespace customisedly. ```-n``` stands for contract name, ```-N``` stands for namespace.

```
$ dotnet new helloworldcontract -n HelloWorld -N AElf.Contracts.HelloWorld
```

For example, ```-n HelloWorld``` means your contract name will be HelloWorld, ```-N AElf.Contracts.HelloWorld``` means your contract namespace will be AElf.Contracts.HelloWorld.
Type the following command to understand usage of all the custom parameters.

```
$ dotnet new helloworldcontract --help
```

### Create and modify proto files

- Create new proto files and modify existed protobuf files according to your requirements. Note that the import path, the path of proto under the `base/contract/message/reference` folder needs to use the absolute path, the path of other imported proto doesn't need to do it. Like the following picture. When we create the proto files under the Protobuf folder, we don't need to add the configs of import proto to csproj file.

### Create and modify class files

- Create new class files and modify existing class files according to your requirements.

### Build

- Run the following command and check the result. If have any errors, solve them according to error messages.

```
$ cd src
$ dotnet build
```

## Testing

### Copy proto files

- With the same method as above, copy proto files from src folder to base, message, stub folders. And update the import path.

### Create and modify class files

- Create new class files and modify existing class files according to your requirements.

### Build and run

- Run the following command and check the result. If have any errors, solve them according to error messages.

```
$ cd test
$ dotnet build
```

- After building successfully, run ```dotnet test``` command. And check the result. If have any errors, solve them according to error messages.

## Deployment

### Start local chain

- Install Docker. Refer to https://www.docker.com/products/docker-desktop/
- Run the following commands, to pull the docker image and run it.

```
$ docker run --name aelf-node --restart always \
    -itd -p 6801:6801 -p 8000:8000 -p 5001:5001 -p 5011:5011 \
    --platform linux/amd64 \
    --ulimit core=-1 \
    --security-opt seccomp=unconfined --privileged=true \
    aelf/standalone-testing-node
```

- Check the log.

### Deploy smart contract

- Run the following command to install aelf-command tool.

```
npm i aelf-command -g
```

- Load the keystore to your local environment.

```
aelf-command load 1111111111111111111111111111111111111111111111111111111111111111
```

- Prepare a smart contract dll file. Go to the src folder of project, and pack it. Then you can see the ```dll.patched``` file under the path `bin/Debug/net6.0/`.

```
$ cd src
$ dotnet pack
```

- Run the following commands to get some information of the chain. Get the GenesisContractAddress value.

```
$ aelf-command get-chain-status -e http://127.0.0.1:8000 
```

- Run the following command to deploy contract.

```
$ aelf-command send {GenesisContractAddress} ProposeNewContract -e http://127.0.0.1:8000
? Enter a valid wallet address, if you don't have, create one by aelf-command create: W1ptWN5n5mfdVvh3khTRm9KMJCAUdge9txNyVtyvZaYRYcqc1
? Enter the password you typed when creating a wallet: {password}
```

And type your category and contract path, deploy it and get the transactionId_1.
```
? category: 0
? code: {your contract dll file path}/contract.dll.patched
```

- Run the following command using the transactionId_1 obtained above to get proposalId_1 and proposedContractInputHash.

```
$ aelf-command event {transactionId_1} -e http://127.0.0.1:8000
```

- Run the following commands and type the Parliament contract address. Then select Approve option and type proposalId_1. After this, get transactionId_2.

```
$ aelf-command send -a W1ptWN5n5mfdVvh3khTRm9KMJCAUdge9txNyVtyvZaYRYcqc1 AElf.ContractNames.Parliament -e http://127.0.0.1:8000
? Enter the password you typed when creating a wallet: {password}
✔ Fetching contract successfully!
? Pick up a contract method: Approve

If you need to pass file contents as a parameter, you can enter the relative or absolute path of the file

Enter the params one by one, type `Enter` to skip optional param:
? Enter the required param <value>: {proposalId_1}
```

- Run the following commands to approve contracts. And get transactionId_2.

```
$ aelf-command send {GenesisContractAddress} ReleaseApprovedContract -e http://127.0.0.1:8000
? Enter a valid wallet address, if you dont have, create one by aelf-command create: W1ptWN5n5mfdVvh3khTRm9KMJCAUdge9txNyVtyvZaYRYcqc1
? Enter the password you typed when creating a wallet: ********
✔ Fetching contract successfully!

If you need to pass file contents as a parameter, you can enter the relative or absolute path of the file

Enter the params one by one, type `Enter` to skip optional param:
? Enter the required param <proposalId>: {proposalId_1}
? Enter the required param <proposedContractInputHash>: {proposedContractInputHash}
```

- Run the following commands to get proposalId_2.

```
$ aelf-command event {transactionId_2} -e http://127.0.0.1:8000
```

- Run the following commands to code check. And get transactionId_3.

```
$ aelf-command send {GenesisContractAddress} ReleaseCodeCheckedContract -e http://127.0.0.1:8000
? Enter a valid wallet address, if you dont have, create one by aelf-command create: W1ptWN5n5mfdVvh3khTRm9KMJCAUdge9txNyVtyvZaYRYcqc1
? Enter the password you typed when creating a wallet: ********
✔ Fetching contract successfully!

If you need to pass file contents as a parameter, you can enter the relative or absolute path of the file

Enter the params one by one, type `Enter` to skip optional param:
? Enter the required param <proposalId>: {proposalId_2}
? Enter the required param <proposedContractInputHash>: {proposedContractInputHash}
b526b
```

- Run the following commands to get deployed information, e.g. contract_address.

```
$ aelf-command event {transactionId_3} -e http://127.0.0.1:8000
```


## Call the contract

- Send aelf commands.
  - Open terminal, type aelf-command send, fill in the node with http://127.0.0.1:8000, address and password are same as before. Fill the contract with address that return before.
```
$ aelf-command send -a W1ptWN5n5mfdVvh3khTRm9KMJCAUdge9txNyVtyvZaYRYcqc1 {contract_address} -e http://127.0.0.1:8000
```
- Select the interface and type parameters.
  - Select method/interface that you want to test. Type the parameters.
- Check result.
  - If call succeeds. You can get the transactionId.
  - Type http://localhost:8000/swagger/index.html and go to the api/blockChain/transactionResult, fill with the transactionId and click Execute. Get the result and check it.
